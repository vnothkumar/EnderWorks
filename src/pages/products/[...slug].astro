---
import { type CollectionEntry, getCollection } from "astro:content";
import { render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { TELEGRAM_LINK } from "../../consts";

export async function getStaticPaths() {
  const posts = await getCollection("products");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

type Props = CollectionEntry<"products">;

const post = Astro.props;
const { Content } = await render(post);

const title = post.data.title + " - Buy Online";
---

<BaseLayout
  title={title}
  image={post.data.images[0]}
  description={post.data.description}
  time={post.data.created_at.toISOString()}
>
  <style>
    :global(.hero) {
      display: none !important;
    }
  </style>
  
  <div class="w-full px-4 lg:px-8 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-12">
      {/* Left Column: Image Carousel */}
      <div class="w-full">
        <div id="product-carousel" class="carousel w-full rounded-2xl shadow-lg overflow-hidden bg-base-200 relative">
          {
            post.data.images.map((image, index) => {
              const prevIndex = index === 0 ? post.data.images.length - 1 : index - 1;
              const nextIndex = index === post.data.images.length - 1 ? 0 : index + 1;
              
              return (
                <div id={`slide${index}`} class="carousel-item relative w-full">
                  <img src={image} alt={post.data.title} class="w-full object-contain h-[300px] sm:h-[400px] lg:h-[500px]" />
                  <div class="absolute flex justify-between transform -translate-y-1/2 left-4 right-4 top-1/2">
                    <button data-target-slide={prevIndex} class="btn btn-circle btn-sm sm:btn-md bg-base-100/80 hover:bg-base-100 border-0 shadow-lg">❮</button> 
                    <button data-target-slide={nextIndex} class="btn btn-circle btn-sm sm:btn-md bg-base-100/80 hover:bg-base-100 border-0 shadow-lg">❯</button>
                  </div>
                </div>
              );
            })
          }
        </div>
        
        {/* Image thumbnails for multiple images */}
        {post.data.images.length > 1 && (
          <div class="flex gap-2 mt-4 overflow-x-auto pb-2">
            {post.data.images.map((image, index) => (
              <button 
                data-thumb-slide={index}
                class="flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 rounded-xl overflow-hidden border-2 border-transparent hover:border-primary transition-all"
              >
                <img src={image} alt={`Thumbnail ${index + 1}`} class="w-full h-full object-cover" />
              </button>
            ))}
          </div>
        )}
      </div>

      <script>
        document.addEventListener('astro:page-load', () => {
          initCarousel();
        });
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCarousel);
        } else {
          initCarousel();
        }

        function initCarousel() {
          const carousel = document.getElementById('product-carousel');
          if (!carousel) return;

          const buttons = carousel.querySelectorAll('[data-target-slide]');
          const thumbs = document.querySelectorAll('[data-thumb-slide]');
          
          buttons.forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', (e) => {
              e.preventDefault();
              scrollToSlide(parseInt(newBtn.getAttribute('data-target-slide')));
            });
          });
          
          thumbs.forEach(thumb => {
            thumb.addEventListener('click', (e) => {
              e.preventDefault();
              scrollToSlide(parseInt(thumb.getAttribute('data-thumb-slide')));
            });
          });
          
          function scrollToSlide(index) {
            const slideWidth = carousel.clientWidth;
            carousel.scrollTo({
              left: index * slideWidth,
              behavior: 'smooth'
            });
          }
        }
      </script>

      {/* Right Column: Product Info */}
      <div class="flex flex-col gap-4">
        {/* Title */}
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold leading-tight">{post.data.title}</h1>
        
        {/* Tags */}
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map((tag) => (
              <a href={`/${tag}/`} class="badge badge-outline badge-lg hover:badge-primary transition-all">{tag}</a>
            ))}
          </div>
        )}
        
        {/* Price */}
        <div class="flex items-center gap-4">
          <span class="text-2xl sm:text-3xl font-bold text-primary">
            {post.data.currency}{post.data.price}
          </span>
        </div>
        
        {/* Description */}
        <div class="prose prose-sm sm:prose-base max-w-none text-base-content/80">
          <p>{post.data.description}</p>
        </div>

        {/* Buy Button */}
        <a
          href={TELEGRAM_LINK}
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-primary btn-lg w-full gap-3 text-lg mt-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
          Buy on Telegram
        </a>

        <div class="divider my-2"></div>

        {/* Content/Details */}
        <div class="prose prose-sm sm:prose-base max-w-none">
          <Content />
        </div>

        {/* Product Details Box */}
        <div class="bg-base-200/50 p-4 sm:p-6 rounded-2xl border border-base-300 mt-4">
          <h3 class="font-bold text-lg mb-3">Product Details</h3>
          <ul class="space-y-2 text-sm sm:text-base">
            <li class="flex justify-between">
              <span class="text-base-content/60">Listed on</span>
              <span class="font-medium">{new Date(post.data.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
            </li>
            {post.data.tags && post.data.tags.length > 0 && (
              <li class="flex justify-between">
                <span class="text-base-content/60">Category</span>
                <span class="font-medium capitalize">{post.data.tags[0]}</span>
              </li>
            )}
          </ul>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

