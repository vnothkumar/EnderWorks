---
import { type CollectionEntry, getCollection } from "astro:content";
import { render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { TELEGRAM_LINK } from "../../consts";

export async function getStaticPaths() {
  const posts = await getCollection("products");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

type Props = CollectionEntry<"products">;

const post = Astro.props;
const { Content } = await render(post);

const title = post.data.title + " - Buy Online";
---

<BaseLayout
  title={title}
  image={post.data.images[0]}
  description={post.data.description}
  time={post.data.created_at.toISOString()}
>
  <style>
    :global(.hero) {
      display: none !important;
    }
  </style>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
      {/* Left Column: Image Carousel */}
      <div id="product-carousel" class="carousel w-full rounded-box shadow-lg overflow-x-auto relative">
        {
          post.data.images.map((image, index) => {
            const prevIndex = index === 0 ? post.data.images.length - 1 : index - 1;
            const nextIndex = index === post.data.images.length - 1 ? 0 : index + 1;
            
            return (
              <div id={`slide${index}`} class="carousel-item relative w-full">
                <img src={image} class="w-full object-contain h-[400px] md:h-[600px]" />
                <div class="absolute flex justify-between transform -translate-y-1/2 left-5 right-5 top-1/2">
                  <button data-target-slide={prevIndex} class="btn btn-circle">❮</button> 
                  <button data-target-slide={nextIndex} class="btn btn-circle">❯</button>
                </div>
              </div>
            );
          })
        }
      </div>

      <script>
        document.addEventListener('astro:page-load', () => {
          initCarousel();
        });
        
        // Fallback for non-ViewTransitions if used, or initial load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCarousel);
        } else {
          initCarousel();
        }

        function initCarousel() {
          const carousel = document.getElementById('product-carousel');
          if (!carousel) return;

          const buttons = carousel.querySelectorAll('[data-target-slide]');
          
          buttons.forEach(btn => {
            // Remove existing listeners to prevent duplicates if init runs multiple times
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', (e) => {
              e.preventDefault();
              const targetIndex = newBtn.getAttribute('data-target-slide');
              const targetSlide = document.getElementById(`slide${targetIndex}`);
              
              if (targetSlide && carousel) {
                // Calculate position based on slide index and carousel width to ensure correct alignment
                const slideWidth = carousel.clientWidth;
                const targetScrollLeft = parseInt(targetIndex) * slideWidth;
                
                carousel.scrollTo({
                  left: targetScrollLeft,
                  behavior: 'smooth'
                });
              }
            });
          });
        }
      </script>

      {/* Right Column: Product Info */}
      <div class="flex flex-col gap-4">
        <h1 class="text-3xl font-bold">{post.data.title}</h1>
        
        <div class="prose max-w-none">
          <p>{post.data.description}</p>
        </div>

        <div class="text-xl font-semibold bg-black text-white px-3 py-2 rounded-lg inline-flex justify-center items-center w-fit">
          {post.data.currency}{post.data.price}
        </div>

        <div class="divider"></div>

        <a
          href={TELEGRAM_LINK}
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-primary btn-lg w-full md:w-auto gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
          Buy on Telegram
        </a>

        <div class="divider"></div>

        <div class="prose max-w-none">
          <Content />
        </div>

        {post.data.tags && post.data.tags.length > 0 && (
          <div class="flex gap-2 mt-4">
            {post.data.tags.map((tag) => (
              <div class="badge badge-outline">{tag}</div>
            ))}
          </div>
        )}

        <div class="divider"></div>

        <div class="bg-base-200 p-4 rounded-box">
          <h3 class="font-bold mb-2">Product Details</h3>
          <ul class="text-sm space-y-1 opacity-70">
            <li><span class="font-semibold">Listed on:</span> {new Date(post.data.created_at).toLocaleDateString()}</li>
            {/* Add more details here if available in frontmatter */}
          </ul>
        </div>
      </div>
    </div>
</BaseLayout>
